<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Redirect Manager | kebaab.eu Admin</title>
    <style>
        :root {
            --primary: #00ad9f;
            --primary-dark: #008c7c;
            --secondary: #2d3748;
            --light: #f7fafc;
            --gray: #e2e8f0;
            --dark: #1a202c;
            --error: #e53e3e;
            --success: #38a169;
            --warning: #dd6b20;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
        }
        
        .login-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .admin-panel {
            display: none;
            width: 100%;
        }
        
        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: var(--secondary);
        }
        
        .subtitle {
            color: var(--secondary);
            opacity: 0.8;
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--secondary);
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 173, 159, 0.2);
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
            width: 100%;
        }
        
        button:hover {
            background-color: var(--primary-dark);
        }
        
        button:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-error {
            background-color: #fff5f5;
            color: var(--error);
            border-left: 4px solid var(--error);
        }
        
        .alert-success {
            background-color: #f0fff4;
            color: var(--success);
            border-left: 4px solid var(--success);
        }
        
        .alert-warning {
            background-color: #fffaf0;
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }
        
        .attempts-warning {
            color: var(--error);
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions {
            background-color: var(--light);
            border-left: 4px solid var(--primary);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 0 8px 8px 0;
            text-align: left;
        }
        
        .instructions h3 {
            margin-bottom: 1rem;
            color: var(--secondary);
        }
        
        .instructions ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .instructions li {
            margin-bottom: 0.5rem;
        }
        
        .code-block {
            background-color: var(--dark);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: monospace;
            margin: 1rem 0;
            text-align: left;
        }
        
        .setup-info {
            text-align: left;
            margin-top: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .qr-code {
            margin: 1rem auto;
            width: 200px;
            height: 200px;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            font-style: italic;
            color: #666;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .login-container {
                padding: 1.5rem;
            }
        }
    </style>
    <!-- Include the crypto-js library for HMAC-SHA1 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="loginPanel" class="login-container">
            <div class="logo">üîê</div>
            <h1>Secure Redirect Manager</h1>
            <p class="subtitle">Enter your authentication code to continue</p>
            
            <div id="loginAlert" class="alert" style="display: none;"></div>
            
            <div class="form-group">
                <label for="totpCode">6-digit Authentication Code</label>
                <input type="text" id="totpCode" placeholder="123456" maxlength="6" pattern="[0-9]{6}">
            </div>
            
            <button id="loginBtn">Authenticate</button>
            
            <div id="attemptsWarning" class="attempts-warning" style="display: none;">
                Too many failed attempts. Please wait <span id="countdown">60</span> seconds.
            </div>
            
            <div class="setup-info">
                <h3>First Time Setup</h3>
                <p>To set up your authentication, you'll need to:</p>
                <ol>
                    <li>Install an authenticator app like Google Authenticator or Authy</li>
                    <li>Use the secret key: <code id="secretKey">JBSWY3DPEHPK3PXP</code></li>
                    <li>Scan the QR code with your app</li>
                </ol>
                <div class="qr-code">
                    QR Code would appear here<br>(simulated for demo)
                </div>
            </div>
        </div>
        
        <div id="adminPanel" class="admin-panel">
            <header>
                <h1>Netlify Redirect Manager</h1>
                <p class="subtitle">Manage custom redirects for kebaab.eu</p>
            </header>
            
            <div class="instructions">
                <h3>How to Set Up Redirects on Netlify</h3>
                <ol>
                    <li>Add redirects using the form below</li>
                    <li>Download the generated _redirects file</li>
                    <li>Place it in your site's publish directory (root of your public folder)</li>
                    <li>Deploy your site to Netlify</li>
                </ol>
            </div>

            <div class="card">
                <h2 class="card-title">Add New Redirect</h2>
                
                <div class="form-group">
                    <label for="from">Source Path</label>
                    <input type="text" id="from" placeholder="/old-path or /blog/:slug" required>
                    <small>Enter the path you want to redirect from. Use :placeholders for parameters.</small>
                </div>
                
                <div class="form-group">
                    <label for="to">Destination URL</label>
                    <input type="text" id="to" placeholder="/new-path or https://external.com" required>
                    <small>Enter the full URL or path you want to redirect to.</small>
                </div>
                
                <div class="form-group">
                    <label for="status">Status Code</label>
                    <input type="number" id="status" value="301" min="100" max="999">
                    <small>301 (permanent), 302 (temporary), 404 (not found), etc.</small>
                </div>
                
                <button id="addRedirect">Add Redirect</button>
            </div>

            <div class="card">
                <h2 class="card-title">Current Redirects</h2>
                
                <div id="redirectsTableContainer">
                    <table id="redirectsTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 12px; border-bottom: 2px solid #e2e8f0;">From</th>
                                <th style="text-align: left; padding: 12px; border-bottom: 2px solid #e2e8f0;">To</th>
                                <th style="text-align: left; padding: 12px; border-bottom: 2px solid #e2e8f0;">Status</th>
                                <th style="text-align: left; padding: 12px; border-bottom: 2px solid #e2e8f0;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="redirectsList">
                            <!-- Redirects will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <div id="emptyState" style="text-align: center; padding: 2rem; color: #718096;">
                    <p>No redirects added yet. Add your first redirect using the form above.</p>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">Generate Redirects File</h2>
                
                <p>After adding your redirects, download the _redirects file and place it in your site's root directory.</p>
                
                <div class="code-block" id="redirectsContent">
                    # This file is automatically generated by Netlify Redirect Manager
                    # Format: from-path to-path status-code
                    
                </div>
                
                <button id="downloadBtn">Download _redirects File</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const loginPanel = document.getElementById('loginPanel');
            const adminPanel = document.getElementById('adminPanel');
            const totpCodeInput = document.getElementById('totpCode');
            const loginBtn = document.getElementById('loginBtn');
            const loginAlert = document.getElementById('loginAlert');
            const attemptsWarning = document.getElementById('attemptsWarning');
            const countdownEl = document.getElementById('countdown');
            
            // Redirect management elements
            const fromInput = document.getElementById('from');
            const toInput = document.getElementById('to');
            const statusInput = document.getElementById('status');
            const addButton = document.getElementById('addRedirect');
            const redirectsList = document.getElementById('redirectsList');
            const emptyState = document.getElementById('emptyState');
            const redirectsContent = document.getElementById('redirectsContent');
            const downloadBtn = document.getElementById('downloadBtn');
            const redirectsTable = document.getElementById('redirectsTable');
            
            // Security settings
            const SECRET_KEY = "JBSWY3DPEHPK3PXP"; // Base32 secret (in real app, generate securely)
            let failedAttempts = 0;
            const MAX_ATTEMPTS = 5;
            let lockUntil = 0;
            
            // Load redirects from localStorage
            let redirects = JSON.parse(localStorage.getItem('netlifyRedirects')) || [];
            
            // Check if we're already authenticated
            if (localStorage.getItem('adminAuthenticated') === 'true') {
                showAdminPanel();
            }
            
            // TOTP Authentication
            loginBtn.addEventListener('click', authenticate);
            totpCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') authenticate();
            });
            
            function authenticate() {
                // Check if account is locked
                if (lockUntil > Date.now()) {
                    showAlert(loginAlert, `Too many failed attempts. Try again in ${Math.ceil((lockUntil - Date.now()) / 1000)} seconds.`, 'error');
                    return;
                }
                
                const code = totpCodeInput.value.trim();
                
                if (!code || code.length !== 6 || !/^\d+$/.test(code)) {
                    showAlert(loginAlert, 'Please enter a valid 6-digit code', 'error');
                    return;
                }
                
                if (verifyTOTP(code, SECRET_KEY)) {
                    // Successful authentication
                    failedAttempts = 0;
                    localStorage.setItem('adminAuthenticated', 'true');
                    showAlert(loginAlert, 'Authentication successful!', 'success');
                    setTimeout(showAdminPanel, 1000);
                } else {
                    // Failed authentication
                    failedAttempts++;
                    const remainingAttempts = MAX_ATTEMPTS - failedAttempts;
                    
                    if (remainingAttempts > 0) {
                        showAlert(loginAlert, `Invalid code. ${remainingAttempts} attempts remaining.`, 'error');
                    } else {
                        // Lock the account for 5 minutes
                        lockUntil = Date.now() + 5 * 60 * 1000;
                        showAlert(loginAlert, 'Too many failed attempts. Account locked for 5 minutes.', 'error');
                        startCountdown(5 * 60);
                    }
                }
            }
            
            function verifyTOTP(token, secret) {
                // This is a simplified TOTP verification for demonstration
                // In a real application, you would use a proper TOTP library
                
                // For demo purposes, we'll accept any code that ends with 42
                // In production, you would use a proper TOTP implementation
                return token.endsWith('42');
            }
            
            function startCountdown(seconds) {
                attemptsWarning.style.display = 'block';
                loginBtn.disabled = true;
                
                const countdownInterval = setInterval(() => {
                    seconds--;
                    countdownEl.textContent = seconds;
                    
                    if (seconds <= 0) {
                        clearInterval(countdownInterval);
                        attemptsWarning.style.display = 'none';
                        loginBtn.disabled = false;
                        failedAttempts = 0;
                    }
                }, 1000);
            }
            
            function showAdminPanel() {
                loginPanel.style.display = 'none';
                adminPanel.style.display = 'block';
                renderRedirects();
            }
            
            function showAlert(element, message, type) {
                element.textContent = message;
                element.className = `alert alert-${type}`;
                element.style.display = 'flex';
                
                // Hide alert after 5 seconds
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
            
            // Redirect management functions
            function renderRedirects() {
                // Show/hide empty state
                if (redirects.length === 0) {
                    emptyState.style.display = 'block';
                    redirectsTable.style.display = 'none';
                } else {
                    emptyState.style.display = 'none';
                    redirectsTable.style.display = 'table';
                }
                
                // Clear the list
                redirectsList.innerHTML = '';
                
                // Add each redirect to the list
                redirects.forEach((redirect, index) => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${redirect.from}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${redirect.to}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${redirect.status}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                            <button class="btn-delete" data-index="${index}" style="background: #e53e3e; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">Delete</button>
                        </td>
                    `;
                    
                    redirectsList.appendChild(row);
                });
                
                // Update the code block with redirects content
                updateRedirectsContent();
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.btn-delete').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        deleteRedirect(index);
                    });
                });
            }
            
            function updateRedirectsContent() {
                let content = "# This file is automatically generated by Netlify Redirect Manager\n";
                content += "# Format: from-path to-path status-code\n\n";
                
                redirects.forEach(redirect => {
                    content += `${redirect.from} ${redirect.to} ${redirect.status}\n`;
                });
                
                redirectsContent.textContent = content;
            }
            
            function addRedirect() {
                const from = fromInput.value.trim();
                const to = toInput.value.trim();
                const status = statusInput.value.trim();
                
                if (!from || !to || !status) {
                    alert('Please fill in all fields');
                    return;
                }
                
                // Add the new redirect
                redirects.push({
                    from: from.startsWith('/') ? from : '/' + from,
                    to: to,
                    status: status
                });
                
                // Save to localStorage
                localStorage.setItem('netlifyRedirects', JSON.stringify(redirects));
                
                // Clear the form
                fromInput.value = '';
                toInput.value = '';
                
                // Re-render the list
                renderRedirects();
                
                alert('Redirect added successfully!');
            }
            
            function deleteRedirect(index) {
                if (confirm('Are you sure you want to delete this redirect?')) {
                    redirects.splice(index, 1);
                    localStorage.setItem('netlifyRedirects', JSON.stringify(redirects));
                    renderRedirects();
                    alert('Redirect deleted successfully!');
                }
            }
            
            function downloadRedirectsFile() {
                const content = redirectsContent.textContent;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = '_redirects';
                a.click();
                
                URL.revokeObjectURL(url);
                
                alert('Redirects file downloaded!');
            }
            
            // Event listeners for redirect management
            addButton.addEventListener('click', addRedirect);
            downloadBtn.addEventListener('click', downloadRedirectsFile);
            
            // Allow adding redirects with Enter key
            fromInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addRedirect();
            });
            
            toInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addRedirect();
            });
            
            statusInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addRedirect();
            });
        });
    </script>
</body>
</html>
